<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PitchCraft AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;700&family=Instrument+Serif&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --Instrument: 'Instrument Serif', sans-serif;
            --Outfit: 'Outfit', 'sans-serif';
        }

        body {
            font-family: 'Instrument Serif', sans-serif;
        }

        .glass-card {
            background: #f8fafc;
            backdrop-filter: blur(10px);
            border-radius: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        #pitch-output {
            max-height: auto;
            overflow-y: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
            background-color: #f0fdf4;
            border: 1px solid #d1fae5;
            border-radius: 0.5rem;
            padding: 1rem;
        }

        #output-text {
            font-family: "Outfit", sans-serif;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 90%;
            width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
    <script src="config.js"></script>
</head>

<body class="bg-gradient-to-b from-[#E8F3FC] to-[#F9FBFD] min-h-screen flex flex-col">

    <!-- NAVBAR -->
    <nav class="w-full bg-white shadow-md py-4 px-6 flex justify-between items-center sticky top-0 z-50">
        <h1 class="text-2xl font-bold text-[#4338ca]">PitchCraft AI</h1>
        <div class="flex items-center space-x-4">
            <span id="user-display" class="font-medium text-gray-700"></span>
            <button id="logout-btn"
                class="px-4 py-2 bg-[#4338ca] hover:bg-[#4f46e5] text-white rounded-lg transition">Sign
                Out</button>
        </div>
    </nav>

    <!-- HERO SECTION -->
    <section
        class="text-center py-20 px-6 lg:px-20 bg-gradient-to-r from-[#40A2E3] to-[#2E8BE6] text-white relative overflow-hidden">
        <h1 class="text-5xl lg:text-6xl font-extrabold mb-4">Transform Your Startup Idea</h1>
        <p class="text-xl lg:text-2xl mb-8">Generate a powerful AI-crafted pitch in seconds and impress investors.</p>
        <button id="hero-cta"
            class="px-6 py-3 bg-white text-[#40A2E3] font-semibold rounded-lg shadow-lg hover:shadow-xl transition">Generate
            Your Pitch</button>
        <div class="absolute top-0 left-0 w-72 h-72 bg-white opacity-10 rounded-full filter blur-3xl -z-10"></div>
        <div class="absolute bottom-0 right-0 w-72 h-72 bg-white opacity-10 rounded-full filter blur-3xl -z-10"></div>
    </section>

    <!-- MAIN CONTENT -->
    <main class="flex flex-col lg:flex-row justify-center gap-10 px-6 lg:px-20 mt-12 mb-20">

        <!-- AI PITCH GENERATOR -->
        <div class="lg:w-2/3 glass-card p-8 shadow-xl">
            <h2 class="text-2xl font-semibold text-[#4338ca] mb-6 border-b pb-4 text-center">üöÄ Generate Your Startup
                Pitch</h2>

            <form id="pitch-form" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-[#4338ca]">Startup Name</label>
                    <input id="startup-name" type="text" placeholder="e.g., HealthMate"
                        class="mt-2 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-[#4338ca]">The Problem</label>
                    <textarea id="problem" rows="3" placeholder="Describe the problem..."
                        class="mt-2 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition"
                        required></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-[#4338ca]">Your Solution / Product</label>
                    <textarea id="solution" rows="3" placeholder="Explain your solution..."
                        class="mt-2 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition"
                        required></textarea>
                </div>

                <button id="generate-button" type="submit"
                    class="w-full py-3 bg-gradient-to-r from-[#4338ca] to-[#2E8BE6] text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                    ‚ú® Generate Pitch
                </button>
            </form>

            <!-- Loading -->
            <div id="loading"
                class="mt-6 hidden text-center text-sky-700 bg-sky-50 rounded-lg py-3 font-medium animate-pulse">
                Generating your pitch... Please wait.
            </div>

            <!-- Output -->
            <section id="pitch-output" class="mt-10 hidden">
                <h3 class="text-xl font-bold text-gray-800 mb-3 border-b pb-2">Your Generated Pitch</h3>
                <div id="output-text"
                    class="bg-gradient-to-br from-sky-50 to-white border border-sky-100 p-5 rounded-xl text-gray-800 shadow-inner prose break-words overflow-x-auto max-w-200px leading-relaxed">
                </div>

                <div id="citation-sources" class="mt-5 text-sm text-gray-500"></div>
            </section>
        </div>

        <!-- HISTORY / DASHBOARD -->
        <div class="lg:w-1/3 glass-card p-8 shadow-xl">
            <h2 class="text-2xl font-semibold text-[#4338ca] mb-6 border-b pb-4 text-center">üìú Pitch History</h2>
            
            <!-- Loading indicator for history -->
            <div id="loading-history" class="text-center text-gray-500 py-4">
                Loading history...
            </div>
            
            <!-- History list -->
            <div id="pitch-history" class="space-y-4 max-h-[500px] overflow-y-auto">
                <!-- History items will be loaded here -->
            </div>
        </div>
    </main>

    <!-- Pitch Modal -->
    <div id="pitch-modal" class="modal">
        <div class="modal-content">
            <button id="close-modal" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            <h3 class="text-2xl font-bold text-[#4338ca] mb-4 font-[--Outfit]">Full Pitch</h3>
            <div id="modal-content" class="text-gray-700"></div>
        </div>
    </div>

    <!-- Firebase JS -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Config
        const firebaseConfig = {
            apiKey: FIREBASE_API_KEY,
            authDomain: "pitch-craft-a20f2.firebaseapp.com",
            projectId: "pitch-craft-a20f2",
            storageBucket: "pitch-craft-a20f2.appspot.com",
            messagingSenderId: "912823133018",
            appId: "1:912823133018:web:0b46413e38559cd2014963",
            measurementId: "G-4EMWVMF2ZL"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        // DOM Elements
        const logoutBtn = document.getElementById('logout-btn');
        const userDisplay = document.getElementById('user-display');
        const pitchHistory = document.getElementById('pitch-history');
        const loadingHistory = document.getElementById('loading-history');
        const modal = document.getElementById('pitch-modal');
        const closeModalBtn = document.getElementById('close-modal');
        const modalContent = document.getElementById('modal-content');

        // Authentication checker
        auth.onAuthStateChanged((user) => {
            if (user) {
                userDisplay.textContent = user.email;
                fetchPitchHistory(user.uid);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Logout button
        logoutBtn.addEventListener('click', () => {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        });

        // Close modal
        closeModalBtn.addEventListener('click', () => {
            modal.classList.remove('active');
        });

        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.remove('active');
            }
        });

        // Fetch Pitch History
        function fetchPitchHistory(uid) {
            const pitchesRef = db.collection('users').doc(uid).collection('pitches');

            pitchesRef.orderBy('createdAt', 'desc').onSnapshot(snapshot => {
                loadingHistory.classList.add('hidden');
                pitchHistory.innerHTML = '';
                
                if (snapshot.empty) {
                    pitchHistory.innerHTML = '<p class="text-center text-gray-500 italic p-4">No pitches saved yet.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    const previewText = data.pitchText ? data.pitchText.substring(0, 100) + '...' : 'No pitch content';

                    const card = document.createElement('div');
                    card.className = 'p-4 bg-white border border-gray-200 rounded-lg shadow hover:shadow-md transition cursor-pointer hover:bg-gray-50';

                    card.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <h4 class="text-md font-semibold text-gray-800">${data.startupName || 'Untitled'}</h4>
                            <button onclick="deletePitch('${doc.id}'); event.stopPropagation();" 
                                    class="text-red-500 hover:text-red-700 text-sm">
                                Delete
                            </button>
                        </div>
                        <p class="text-sm text-gray-600 mb-2">${previewText}</p>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-gray-400">Date: ${date}</span>
                            <button onclick="viewPitch('${doc.id}'); event.stopPropagation();" 
                                    class="text-[#4338ca] hover:text-[#4f46e5] text-sm font-medium">
                                View Full Pitch ‚Üí
                            </button>
                        </div>
                    `;

                    // Open modal on click
                    card.addEventListener('click', () => {
                        viewPitch(doc.id);
                    });

                    pitchHistory.appendChild(card);
                });
            }, error => {
                console.error('Error fetching pitch history:', error);
                loadingHistory.innerHTML = '<p class="text-center text-red-500">Error loading history</p>';
            });
        }

        // View pitch in modal
        async function viewPitch(pitchId) {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const doc = await db.collection('users').doc(user.uid).collection('pitches').doc(pitchId).get();
                if (doc.exists) {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                    
                    modalContent.innerHTML = `
                        <div class="space-y-4">
                            <div class="border-b pb-3">
                                <h1 class="text-2xl font-extrabold text-[#4338ca] mb-1 capitalize font-[Roboto]">${data.startupName || 'Untitled'}</h1>
                                <p class="text-sm text-gray-500">Created on: ${date}</p>
                            </div>
                            
                            <div>
                                <h2 class="font-semibold text-gray-800 text-lg mb-1">Problem:</h2>
                                <p class="text-gray-700 bg-gray-50 p-3 rounded-lg border border-gray-600">${data.problem || 'N/A'}</p>
                            </div>
                            
                            <div>
                                <h2 class="font-semibold text-gray-800 text-lg mb-1">Solution:</h2>
                                <p class="text-gray-700 bg-gray-50 p-3 rounded-lg border border-gray-600">${data.solution || 'N/A'}</p>
                            </div>
                            
                            <div>
                                <h2 class="font-semibold text-gray-800 text-lg mb-1">Generated Pitch:</h2>
                                <div class="bg-gradient-to-br from-sky-50 to-white p-4 rounded-lg border border-sky-100 font-[Roboto]">
                                    ${data.pitchText ? data.pitchText.replace(/\n/g, '<br>') : 'N/A'}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    modal.classList.add('active');
                }
            } catch (error) {
                console.error('Error fetching pitch:', error);
                modalContent.innerHTML = '<p class="text-red-500">Error loading pitch details</p>';
                modal.classList.add('active');
            }
        }

        // Delete pitch
        async function deletePitch(pitchId) {
            const user = auth.currentUser;
            if (!user) return;
            
            if (confirm('Are you sure you want to delete this pitch?')) {
                try {
                    await db.collection('users').doc(user.uid).collection('pitches').doc(pitchId).delete();
                } catch (error) {
                    console.error('Error deleting pitch:', error);
                    alert('Error deleting pitch');
                }
            }
        }

        // AI Pitch Generator Logic
        const pitchForm = document.getElementById('pitch-form');
        const generateButton = document.getElementById('generate-button');
        const loadingDiv = document.getElementById('loading');
        const pitchOutput = document.getElementById('pitch-output');
        const outputText = document.getElementById('output-text');
        const heroCta = document.getElementById('hero-cta');

        // Hero CTA button scrolls to form
        heroCta.addEventListener('click', () => {
            document.getElementById('pitch-form').scrollIntoView({ behavior: 'smooth' });
        });

        pitchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const startupName = document.getElementById('startup-name').value.trim();
            const problem = document.getElementById('problem').value.trim();
            const solution = document.getElementById('solution').value.trim();

            if (!startupName || !problem || !solution) {
                alert('Please fill in all fields');
                return;
            }

            loadingDiv.classList.remove('hidden');
            generateButton.disabled = true;
            outputText.innerHTML = '';

            try {
                // Prepare the payload for the AI API
                const systemPrompt = `You are PitchCraft, an expert startup pitch generator. 
                    Your task is to generate a clear, concise, and engaging startup pitch (200-300 words) based on the input provided. 
                    Format the pitch with: 

                    - A bold title for the startup üè∑Ô∏è
                    - Clearly separated sections with headings for The Problem ‚ùó, The Solution üí°, Market Opportunity üìà, and Traction & Ask üöÄ
                    - Include relevant emojis in headings or key points to make it visually appealing
                    - Use professional, persuasive, and investor-friendly language
                    - Keep paragraphs concise, readable, and structured for easy comprehension

                    Always ensure the output is polished, actionable, and investor-ready.`;

                const userQuery = `
                    Startup Name: ${startupName}
                    Problem: ${problem}
                    Solution: ${solution}`;
                const apiKey = GOOGLE_AI_API_KEY;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API error: ${response.status}`);

                const result = await response.json();
                const aiText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No pitch generated.";

                // Display AI-generated pitch
                outputText.innerHTML = `<div class="p-6 bg-white rounded-2xl shadow-lg space-y-4 max-w-full">${aiText
                    .replace(/^##\s*(.*)$/gm, '<h1 class="text-3xl font-extrabold font-[--Instrument] text-[#4338ca] mb-4">$1</h1>')
                    .replace(/^###\s*(.*)$/gm, '<h2 class="text-xl font-semiextrabold text-gray-800 mt-4 mb-2">$1</h2>')
                    .replace(/^\*{2}(.*)\*{2}$/gm, '<strong class="text-[#4338ca]">$1</strong>')
                    .replace(/^\*\s*(.*)$/gm, '<li class="ml-6 list-disc text-gray-700">$1</li>')
                    .replace(/\n/g, '<br>')}</div>`;
                pitchOutput.classList.remove('hidden');

                // Save to Firestore
                const user = auth.currentUser;
                if (user) {
                    await db.collection('users').doc(user.uid).collection('pitches').add({
                        startupName,
                        problem,
                        solution,
                        pitchText: aiText,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Refresh history
                    fetchPitchHistory(user.uid);
                }
            } catch (err) {
                console.error(err);
                outputText.innerHTML = `<p class="text-red-500 font-semibold">Error generating pitch: ${err.message}</p>`;
                pitchOutput.classList.remove('hidden');
            } finally {
                loadingDiv.classList.add('hidden');
                generateButton.disabled = false;
            }
        });
    </script>

</body>

</html>